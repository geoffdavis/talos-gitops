---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: authentik-admin-token-enhanced
  namespace: authentik
  labels:
    app.kubernetes.io/name: authentik
    app.kubernetes.io/component: token-management
    app.kubernetes.io/part-of: authentik
  annotations:
    external-secrets.io/refresh-interval: "5m"
    token-management.authentik.io/rotation-enabled: "true"
    token-management.authentik.io/overlap-days: "30"
spec:
  refreshInterval: 5m
  secretStoreRef:
    name: onepassword-connect
    kind: ClusterSecretStore
  target:
    name: authentik-radius-token
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: authentik
          app.kubernetes.io/component: token-management
          app.kubernetes.io/part-of: authentik
        annotations:
          token-management.authentik.io/last-rotation: "{{ .last_rotation | default \"never\" }}"
          token-management.authentik.io/expires: "{{ .expires | default \"unknown\" }}"
          token-management.authentik.io/created: "{{ .created | default \"unknown\" }}"
          token-management.authentik.io/description: "{{ .description | default \"Authentik API Token\" }}"
          token-management.authentik.io/rotation-status: "{{ .rotation_status | default \"active\" }}"
      data:
        # Primary token (active)
        token: "{{ .token }}"
        
        # Token metadata for rotation management
        expires: "{{ .expires | default \"\" }}"
        created: "{{ .created | default \"\" }}"
        description: "{{ .description | default \"\" }}"
        last_rotation: "{{ .last_rotation | default \"\" }}"
        rotation_status: "{{ .rotation_status | default \"active\" }}"
        
        # Secondary token for overlap during rotation (optional)
        token_secondary: "{{ .token_secondary | default \"\" }}"
        expires_secondary: "{{ .expires_secondary | default \"\" }}"
        created_secondary: "{{ .created_secondary | default \"\" }}"
        
        # Token validation endpoint for health checks
        validation_endpoint: "http://authentik-server.authentik.svc.cluster.local/api/v3/core/users/me/"
  data:
    - secretKey: token
      remoteRef:
        key: "Authentik Admin Token"
        property: "token"
    - secretKey: expires
      remoteRef:
        key: "Authentik Admin Token"
        property: "expires"
    - secretKey: created
      remoteRef:
        key: "Authentik Admin Token"
        property: "created"
    - secretKey: description
      remoteRef:
        key: "Authentik Admin Token"
        property: "description"
    - secretKey: last_rotation
      remoteRef:
        key: "Authentik Admin Token"
        property: "last_rotation"
    - secretKey: rotation_status
      remoteRef:
        key: "Authentik Admin Token"
        property: "rotation_status"
    # Optional secondary token fields for rotation overlap
    - secretKey: token_secondary
      remoteRef:
        key: "Authentik Admin Token"
        property: "token_secondary"
    - secretKey: expires_secondary
      remoteRef:
        key: "Authentik Admin Token"
        property: "expires_secondary"
    - secretKey: created_secondary
      remoteRef:
        key: "Authentik Admin Token"
        property: "created_secondary"
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: authentik-token-rotation-config
  namespace: authentik
  labels:
    app.kubernetes.io/name: authentik
    app.kubernetes.io/component: token-management
    app.kubernetes.io/part-of: authentik
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: onepassword-connect
    kind: ClusterSecretStore
  target:
    name: authentik-token-rotation-config
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: authentik
          app.kubernetes.io/component: token-management
      data:
        # Rotation configuration
        rotation_enabled: "{{ .rotation_enabled | default \"true\" }}"
        overlap_days: "{{ .overlap_days | default \"30\" }}"
        check_interval: "{{ .check_interval | default \"24h\" }}"
        warning_days: "{{ .warning_days | default \"60\" }}"
        
        # 1Password configuration
        onepassword_vault: "{{ .onepassword_vault | default \"homelab\" }}"
        onepassword_item: "{{ .onepassword_item | default \"Authentik Admin Token\" }}"
        
        # Notification configuration
        notification_enabled: "{{ .notification_enabled | default \"true\" }}"
        notification_webhook: "{{ .notification_webhook | default \"\" }}"
        
        # Token validation configuration
        validation_enabled: "{{ .validation_enabled | default \"true\" }}"
        validation_timeout: "{{ .validation_timeout | default \"30s\" }}"
  data:
    - secretKey: rotation_enabled
      remoteRef:
        key: "Authentik Token Rotation Config"
        property: "rotation_enabled"
    - secretKey: overlap_days
      remoteRef:
        key: "Authentik Token Rotation Config"
        property: "overlap_days"
    - secretKey: check_interval
      remoteRef:
        key: "Authentik Token Rotation Config"
        property: "check_interval"
    - secretKey: warning_days
      remoteRef:
        key: "Authentik Token Rotation Config"
        property: "warning_days"
    - secretKey: onepassword_vault
      remoteRef:
        key: "Authentik Token Rotation Config"
        property: "onepassword_vault"
    - secretKey: onepassword_item
      remoteRef:
        key: "Authentik Token Rotation Config"
        property: "onepassword_item"
    - secretKey: notification_enabled
      remoteRef:
        key: "Authentik Token Rotation Config"
        property: "notification_enabled"
    - secretKey: notification_webhook
      remoteRef:
        key: "Authentik Token Rotation Config"
        property: "notification_webhook"
    - secretKey: validation_enabled
      remoteRef:
        key: "Authentik Token Rotation Config"
        property: "validation_enabled"
    - secretKey: validation_timeout
      remoteRef:
        key: "Authentik Token Rotation Config"
        property: "validation_timeout"
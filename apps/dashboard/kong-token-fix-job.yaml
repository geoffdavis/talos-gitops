apiVersion: batch/v1
kind: Job
metadata:
  name: kong-config-processor
  namespace: kubernetes-dashboard
  labels:
    app.kubernetes.io/name: kubernetes-dashboard
    app.kubernetes.io/component: kong-config-processor
spec:
  template:
    spec:
      serviceAccountName: kubernetes-dashboard-kong
      restartPolicy: Never
      containers:
        - name: config-processor
          image: alpine/k8s:1.31.1
          command: ["/bin/sh"]
          args:
            - -c
            - |
              echo "Reading service account token..."
              SA_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
              echo "Token length: ${#SA_TOKEN}"

              echo "Processing Kong configuration..."
              sed "s/\$(SA_TOKEN)/$SA_TOKEN/g" /tmp/kong-config/kong.yml > /processed-config/kong.yml

              echo "Creating processed ConfigMap..."
              kubectl delete configmap kubernetes-dashboard-kong-config --ignore-not-found=true
              kubectl create configmap kubernetes-dashboard-kong-config --from-file=kong.yml=/processed-config/kong.yml

              echo "Kong configuration ConfigMap updated successfully"
              echo "Configuration file size: $(wc -c < /processed-config/kong.yml) bytes"
          volumeMounts:
            - name: kubernetes-dashboard-kong-config-template
              mountPath: /tmp/kong-config
            - name: processed-config-volume
              mountPath: /processed-config
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            allowPrivilegeEscalation: false
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop: ["ALL"]
      volumes:
        - name: kubernetes-dashboard-kong-config-template
          configMap:
            name: kubernetes-dashboard-kong-config-template
        - name: processed-config-volume
          emptyDir: {}

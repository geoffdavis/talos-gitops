apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  interval: 30m
  chart:
    spec:
      chart: kubernetes-dashboard
      version: "7.13.0"
      sourceRef:
        kind: HelmRepository
        name: kubernetes-dashboard
        namespace: flux-system
      interval: 12h
  values:
    app:
      # Disable direct ingress access (use Kong proxy instead)
      ingress:
        enabled: false

    # Disable nginx (Kong will handle routing)
    nginx:
      enabled: false

    # Disable cert-manager (handled by Kong ingress)
    cert-manager:
      enabled: false

    # Disable metrics-server (already deployed separately)
    metrics-server:
      enabled: false

    # Enable Kong as required proxy with authentication
    kong:
      enabled: true
      # Kong proxy configuration
      proxy:
        tls:
          servicePort: 8443
        # Enable Kong ingress for external access
        ingress:
          enabled: true
          ingressClassName: nginx-internal
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
            nginx.ingress.kubernetes.io/ssl-redirect: "true"
            nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
            # External DNS annotations for DNS record creation
            external-dns.alpha.kubernetes.io/hostname: "dashboard.k8s.home.geoffdavis.com"
            external-dns.alpha.kubernetes.io/ttl: "300"
            # Enable OIDC authentication via nginx-ingress
            nginx.ingress.kubernetes.io/auth-url: >-
              https://authentik.k8s.home.geoffdavis.com/outpost.goauthentik.io/auth/nginx
            nginx.ingress.kubernetes.io/auth-signin: >-
              https://authentik.k8s.home.geoffdavis.com/outpost.goauthentik.io/start?rd=$escaped_request_uri
            nginx.ingress.kubernetes.io/auth-response-headers: >-
              X-authentik-username,X-authentik-groups,X-authentik-email,X-authentik-name,X-authentik-uid
          hosts:
            - host: dashboard.k8s.home.geoffdavis.com
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - secretName: dashboard-tls # pragma: allowlist secret
              hosts:
                - dashboard.k8s.home.geoffdavis.com

    # Configure the dashboard API for header-based authentication
    api:
      containers:
        args:
          - --namespace=kubernetes-dashboard
          - --metrics-scraper-service-name=kubernetes-dashboard-metrics-scraper
        resources:
          requests:
            cpu: 100m
            memory: 200Mi
          limits:
            cpu: 200m
            memory: 400Mi

      nodeSelector:
        kubernetes.io/os: linux

      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/master
          operator: Exists
          effect: NoSchedule

    # Configure web frontend for header-based authentication
    web:
      containers:
        env:
          - name: KUBERNETES_DASHBOARD_API_URL
            value: "/api"
        args:
          - --settings-config-map-name=kubernetes-dashboard-settings
        resources:
          requests:
            cpu: 100m
            memory: 200Mi
          limits:
            cpu: 200m
            memory: 400Mi

      nodeSelector:
        kubernetes.io/os: linux

      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/master
          operator: Exists
          effect: NoSchedule

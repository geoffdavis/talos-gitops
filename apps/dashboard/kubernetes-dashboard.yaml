apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  interval: 30m
  chart:
    spec:
      chart: kubernetes-dashboard
      version: "7.13.0"
      sourceRef:
        kind: HelmRepository
        name: kubernetes-dashboard
        namespace: flux-system
      interval: 12h
  values:
    app:
      # Enable direct ingress access (bypassing Kong proxy)
      ingress:
        enabled: true
        ingressClassName: nginx-internal
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-prod
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
          nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
          # External DNS annotations for DNS record creation
          external-dns.alpha.kubernetes.io/hostname: "dashboard.k8s.home.geoffdavis.com"
          external-dns.alpha.kubernetes.io/ttl: "300"
          # Enable OIDC authentication via nginx-ingress
          nginx.ingress.kubernetes.io/auth-url: >-
            https://authentik.k8s.home.geoffdavis.com/outpost.goauthentik.io/auth/nginx
          nginx.ingress.kubernetes.io/auth-signin: >-
            https://authentik.k8s.home.geoffdavis.com/outpost.goauthentik.io/start?rd=$escaped_request_uri
          nginx.ingress.kubernetes.io/auth-response-headers: >-
            X-authentik-username,X-authentik-groups,X-authentik-email,X-authentik-name,X-authentik-uid
          nginx.ingress.kubernetes.io/auth-snippet: |
            proxy_set_header X-Forwarded-Host $http_host;
        hosts:
          - host: dashboard.k8s.home.geoffdavis.com
            paths:
              - path: /
                pathType: Prefix
        tls:
          enabled: true
          secretName: dashboard-tls # pragma: allowlist secret
          hosts:
            - dashboard.k8s.home.geoffdavis.com

    # Disable nginx (we're using ingress-nginx instead)
    nginx:
      enabled: false

    # Disable cert-manager (handled by ingress)
    cert-manager:
      enabled: false

    # Disable metrics-server (already deployed separately)
    metrics-server:
      enabled: false

    # Completely disable Kong to eliminate token prompting
    kong:
      enabled: false
      # Provide required values even when disabled to prevent template errors
      proxy:
        tls:
          servicePort: 8443
      # Add fullname template to prevent template errors
      fullnameOverride: "kubernetes-dashboard-kong"

    # Configure the dashboard API for header-based authentication
    api:
      containers:
        args:
          - --enable-insecure-login
          - --enable-skip-login
          - --disable-settings-authorizer
          - --namespace=kubernetes-dashboard
          - --metrics-scraper-service-name=kubernetes-dashboard-metrics-scraper
        resources:
          requests:
            cpu: 100m
            memory: 200Mi
          limits:
            cpu: 200m
            memory: 400Mi

      nodeSelector:
        kubernetes.io/os: linux

      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/master
          operator: Exists
          effect: NoSchedule

    # Configure web frontend for header-based authentication
    web:
      containers:
        env:
          - name: KUBERNETES_DASHBOARD_API_URL
            value: "/api"
          - name: KUBERNETES_DASHBOARD_SKIP_LOGIN_PAGE
            value: "true"
          - name: KUBERNETES_DASHBOARD_ENABLE_SKIP_LOGIN
            value: "true"
          - name: KUBERNETES_DASHBOARD_ENABLE_INSECURE_LOGIN
            value: "true"
          - name: KUBERNETES_DASHBOARD_AUTH_MODE
            value: "header"
          - name: KUBERNETES_DASHBOARD_DISABLE_AUTH
            value: "true"
        args:
          - --settings-config-map-name=kubernetes-dashboard-settings
        resources:
          requests:
            cpu: 100m
            memory: 200Mi
          limits:
            cpu: 200m
            memory: 400Mi

      nodeSelector:
        kubernetes.io/os: linux

      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/master
          operator: Exists
          effect: NoSchedule

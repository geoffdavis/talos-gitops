# Talos control plane configuration patch for Intel Mac mini
machine:
  type: controlplane
  install:
    diskSelector:
      model: APPLE*  # Select Apple internal storage
    # Custom installer image with extensions via Talos Image Factory
    # Generated by: task talos:generate-schematic
    # renovate: datasource=github-releases depName=siderolabs/talos
    image: https://factory.talos.dev/image/ced720bf79203f5297a63edcdbbf43a0922c2a66dcfa6676b1cc1ce46d105be1/v1.10.5/metal-amd64.tar.gz
    wipe: false
    extraKernelArgs:
      - talos.logging.kernel=udp://172.29.51.1:514/
  network:
    interfaces:
      - interface: eth0
        dhcp: true
        dhcpOptions:
          routeMetric: 1024
        vip:
          ip: 172.29.51.10
  kubelet:
    extraArgs:
      feature-gates: GracefulNodeShutdown=true
    extraConfig:
      shutdownGracePeriod: 30s
      shutdownGracePeriodCriticalPods: 10s
  # Use DHCP-provided NTP servers instead of hardcoded ones
  sysctls:
    net.ipv4.ip_forward: "1"
    net.ipv6.conf.all.forwarding: "1"
  systemDiskEncryption:
    ephemeral:
      provider: luks2
      keys:
        - nodeID: {}
          slot: 0
    state:
      provider: luks2
      keys:
        - nodeID: {}
          slot: 0
  # Extensions included in custom installer image via Talos Image Factory:
  # ✅ iscsi-tools (Longhorn storage)
  # ✅ ext-lldpd (network discovery)
  # ✅ usb-modem-drivers (Mac mini USB devices)
  # ✅ thunderbolt (Mac mini Thunderbolt devices)
  # Schematic ID: ced720bf79203f5297a63edcdbbf43a0922c2a66dcfa6676b1cc1ce46d105be1
cluster:
  allowSchedulingOnControlPlanes: true
  apiServer:
    extraArgs:
      oidc-issuer-url: https://auth.homelab.local
      oidc-client-id: kubernetes
      oidc-username-claim: email
      oidc-groups-claim: groups
  controllerManager:
    extraArgs:
      bind-address: 0.0.0.0
      # Optimize for multi-control-plane cluster
      leader-elect-lease-duration: 15s
      leader-elect-renew-deadline: 10s
      leader-elect-retry-period: 2s
  scheduler:
    extraArgs:
      bind-address: 0.0.0.0
      # Optimize for multi-control-plane cluster
      leader-elect-lease-duration: 15s
      leader-elect-renew-deadline: 10s
      leader-elect-retry-period: 2s
  etcd:
    extraArgs:
      listen-metrics-urls: http://0.0.0.0:2381
      # Optimize for 3-node etcd cluster
      heartbeat-interval: 100
      election-timeout: 1000
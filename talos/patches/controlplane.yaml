# Talos control plane configuration patch for Intel Mac mini
machine:
  type: controlplane
  install:
    diskSelector:
      model: APPLE*  # Select Apple internal storage
    # renovate: datasource=github-releases depName=siderolabs/talos
    image: ghcr.io/siderolabs/talos:v1.10.4
    wipe: false
    extraKernelArgs:
      - talos.logging.kernel=udp://172.29.51.1:514/
  network:
    interfaces:
      - interface: eth0
        dhcp: true
        vip:
          ip: 172.29.51.10
  kubelet:
    extraArgs:
      feature-gates: GracefulNodeShutdown=true
      shutdown-grace-period: 30s
      shutdown-grace-period-critical-pods: 10s
  time:
    servers:
      - time.cloudflare.com
      - pool.ntp.org
  sysctls:
    net.ipv4.ip_forward: "1"
    net.ipv6.conf.all.forwarding: "1"
  systemDiskEncryption:
    ephemeral:
      provider: luks2
      keys:
        - nodeID: {}
          slot: 0
    state:
      provider: luks2
      keys:
        - nodeID: {}
          slot: 0
  # NOTE: In Talos v1.10+, system extensions are no longer configured in machine config
  # Extensions must be included in custom installer images or boot assets
  # See: https://www.talos.dev/v1.10/talos-guides/configuration/system-extensions/
  # TODO: Create custom installer image with: iscsi-tools, ext-lldpd, usb-modem-drivers, thunderbolt
cluster:
  allowSchedulingOnControlPlanes: true
  apiServer:
    extraArgs:
      oidc-issuer-url: https://auth.homelab.local
      oidc-client-id: kubernetes
      oidc-username-claim: email
      oidc-groups-claim: groups
  controllerManager:
    extraArgs:
      bind-address: 0.0.0.0
  scheduler:
    extraArgs:
      bind-address: 0.0.0.0
  etcd:
    extraArgs:
      listen-metrics-urls: http://0.0.0.0:2381